import 'package:ml_algo/src/retrieval/kd_tree/kd_tree.dart';
import 'package:ml_dataframe/ml_dataframe.dart';
import 'package:ml_linalg/matrix.dart';
import 'package:test/test.dart';

void main() {
  group('KDTree', () {
    final data = [
      [3.43, 10.91, 11.62, -12.93, -11.66],
      [19.41, -4.96, 3.99, 16.35, 10.57],
      [11.30, 8.89, -17.66, -5.17, 16.20],
      [-8.13, -5.23, 18.01, 1.97, 9.08],
      [13.98, -8.21, 17.01, -5.14, 14.49],
      [-17.65, 13.10, 5.82, 8.61, 14.41],
      [4.16, -4.72, -3.71, -2.32, -13.70],
      [7.29, 11.16, -9.51, -1.89, -18.94],
      [19.81, 3.17, 14.27, 0.05, -17.93],
      [-9.63, 18.82, -14.40, -1.91, -6.58],
      [-10.95, -19.58, 9.05, 17.39, 3.30],
      [4.08, -13.19, -5.71, 18.56, -0.13],
      [2.79, -9.15, 6.56, -18.59, 13.53],
      [-7.56, 11.97, 6.55, -7.54, 15.90],
      [-15.97, -15.95, 7.71, 9.70, 16.94],
      [-15.01, 16.12, -10.42, -17.61, 6.27],
      [7.63, -10.70, 15.09, 10.25, -18.16],
      [0.05, 9.74, 7.08, 15.49, -17.99],
      [-6.48, 1.10, 9.28, 0.90, 6.09],
      [-9.88, -5.66, -16.15, 4.46, 2.34],
    ];
    final matrix = Matrix.fromList(data);

    // ==================================================

    // variances: (126.0925521850586, 126.91996002197266, 123.5212631225586, 117.52980041503906, 168.07708740234375), colIdx=4, mean=1.2015000462532044
    // node vector: [-9.88, -5.66, -16.15, 4.46, 2.34],

    final data21 = [
      [3.43, 10.91, 11.62, -12.93, -11.66],
      [4.16, -4.72, -3.71, -2.32, -13.70],
      [7.29, 11.16, -9.51, -1.89, -18.94],
      [19.81, 3.17, 14.27, 0.05, -17.93],
      [-9.63, 18.82, -14.40, -1.91, -6.58],
      [4.08, -13.19, -5.71, 18.56, -0.13],
      [7.63, -10.70, 15.09, 10.25, -18.16],
      [0.05, 9.74, 7.08, 15.49, -17.99],
    ];
    // variances: (59.09866714477539, 116.76374816894531, 116.69230651855469, 98.6568603515625, 40.0130729675293), colIdx=1, mean=3.1487499475479126
    // node vector: [19.81, 3.17, 14.27, 0.05, -17.93]

    final data22 = [
      [19.41, -4.96, 3.99, 16.35, 10.57],
      [11.30, 8.89, -17.66, -5.17, 16.20],
      [-8.13, -5.23, 18.01, 1.97, 9.08],
      [13.98, -8.21, 17.01, -5.14, 14.49],
      [-17.65, 13.10, 5.82, 8.61, 14.41],
      [-10.95, -19.58, 9.05, 17.39, 3.30],
      [2.79, -9.15, 6.56, -18.59, 13.53],
      [-7.56, 11.97, 6.55, -7.54, 15.90],
      [-15.97, -15.95, 7.71, 9.70, 16.94],
      [-15.01, 16.12, -10.42, -17.61, 6.27],
      [-6.48, 1.10, 9.28, 0.90, 6.09],
      [-9.88, -5.66, -16.15, 4.46, 2.34],
    ];
    // variances: (143.32073974609375, 125.18224334716797, 127.2080307006836, 127.156005859375, 25.040782928466797), colIdx=0, mean=-3.6791666746139526
    // node vector: [2.79, -9.15, 6.56, -18.59, 13.53],

    // ==================================================

    final data31 = [
      [4.16, -4.72, -3.71, -2.32, -13.70],
      [4.08, -13.19, -5.71, 18.56, -0.13],
      [7.63, -10.70, 15.09, 10.25, -18.16],
    ];

    final data32 = [
      [3.43, 10.91, 11.62, -12.93, -11.66],
      [7.29, 11.16, -9.51, -1.89, -18.94],
      [19.81, 3.17, 14.27, 0.05, -17.93],
      [-9.63, 18.82, -14.40, -1.91, -6.58],
      [0.05, 9.74, 7.08, 15.49, -17.99],
    ];
    // variances: (92.4607925415039, 24.75891876220703, 134.03343200683594, 82.81289672851562, 22.875722885131836), colIdx=2, mean=1.8120002746582031
    // node vector: [0.05, 9.74, 7.08, 15.49, -17.99],

    final data33 = [
      [-8.13, -5.23, 18.01, 1.97, 9.08],
      [-17.65, 13.10, 5.82, 8.61, 14.41],
      [-10.95, -19.58, 9.05, 17.39, 3.30],
      [-7.56, 11.97, 6.55, -7.54, 15.90],
      [-15.97, -15.95, 7.71, 9.70, 16.94],
      [-15.01, 16.12, -10.42, -17.61, 6.27],
      [-6.48, 1.10, 9.28, 0.90, 6.09],
      [-9.88, -5.66, -16.15, 4.46, 2.34],
    ];
    // variances: (15.639274597167969, 158.8738250732422, 110.82763671875, 102.77732849121094, 29.002010345458984), colIdx=1, mean=-0.5162497758865356
    // node vector: [-6.48, 1.10, 9.28, 0.90, 6.09],

    final data34 = [
      [19.41, -4.96, 3.99, 16.35, 10.57],
      [11.30, 8.89, -17.66, -5.17, 16.20],
      [13.98, -8.21, 17.01, -5.14, 14.49],
      [2.79, -9.15, 6.56, -18.59, 13.53],
    ];
    // variances: (36.01874923706055, 52.41727066040039, 158.91671752929688, 156.67086791992188, 4.1749701499938965), colIdx=2, mean=2.4750000834465027
    // node vector: [19.41, -4.96, 3.99, 16.35, 10.57],

    // ==================================================

    final data41 = [
      [7.29, 11.16, -9.51, -1.89, -18.94],
      [-9.63, 18.82, -14.40, -1.91, -6.58],
    ];

    final data42 = [
      [3.43, 10.91, 11.62, -12.93, -11.66],
      [19.81, 3.17, 14.27, 0.05, -17.93],
      [0.05, 9.74, 7.08, 15.49, -17.99],
    ];

    final data43 = [
      [-8.13, -5.23, 18.01, 1.97, 9.08],
      [-10.95, -19.58, 9.05, 17.39, 3.30],
      [-15.97, -15.95, 7.71, 9.70, 16.94],
      [-9.88, -5.66, -16.15, 4.46, 2.34],
    ];
    // variances: (8.494620323181152, 39.61582565307617, 159.96327209472656, 34.84424591064453, 33.79667663574219), colIdx=2, mean=4.65500020980835
    // node vector: [-15.97, -15.95, 7.71, 9.70, 16.94],

    final data44 = [
      [-17.65, 13.10, 5.82, 8.61, 14.41],
      [-7.56, 11.97, 6.55, -7.54, 15.90],
      [-15.01, 16.12, -10.42, -17.61, 6.27],
      [-6.48, 1.10, 9.28, 0.90, 6.09],
    ];
    // variances: (22.686025619506836, 32.2110710144043, 59.98536682128906, 95.1883544921875, 20.41921615600586), colIdx=3, mean=-3.9100002348423004
    // node vector: [-6.48, 1.10, 9.28, 0.90, 6.09],

    final data45 = [
      [11.30, 8.89, -17.66, -5.17, 16.20],
    ];

    final data46 = [
      [19.41, -4.96, 3.99, 16.35, 10.57],
      [13.98, -8.21, 17.01, -5.14, 14.49],
      [2.79, -9.15, 6.56, -18.59, 13.53],
    ];

    // ==================================================

    final data51 = [
      [-9.88, -5.66, -16.15, 4.46, 2.34],
    ];

    final data52 = [
      [-8.13, -5.23, 18.01, 1.97, 9.08],
      [-10.95, -19.58, 9.05, 17.39, 3.30],
      [-15.97, -15.95, 7.71, 9.70, 16.94],
    ];

    final data53 = [
      [-7.56, 11.97, 6.55, -7.54, 15.90],
      [-15.01, 16.12, -10.42, -17.61, 6.27],
    ];

    final data54 = [
      [-17.65, 13.10, 5.82, 8.61, 14.41],
      [-6.48, 1.10, 9.28, 0.90, 6.09],
    ];

    final kdTree = KDTree(DataFrame(data, headerExists: false), leafSie: 3);

    test('should build a correct structure', () {
      expect(kdTree.toJson(), {
        'L': 3,
        'R': {
          'V': {
            'DT': 'F32',
            'D': [
              -9.880000114440918,
              -5.659999847412109,
              -16.149999618530273,
              4.460000038146973,
              2.3399999141693115,
            ],
          },
          'I': 4,
          'L': {
            'V': {
              'DT': 'F32',
              'D': [
                19.809999465942383,
                3.1700000762939453,
                14.270000457763672,
                0.05000000074505806,
                -17.93000030517578,
              ],
            },
            'I': 1,
            'L': {
              'S': {
                'DT': 'F32',
                'D': [
                  [
                    4.159999847412109,
                    -4.71999979019165,
                    -3.7100000381469727,
                    -2.319999933242798,
                    -13.699999809265137
                  ],
                  [
                    4.079999923706055,
                    -13.1899995803833,
                    -5.710000038146973,
                    18.559999465942383,
                    -0.12999999523162842
                  ],
                  [
                    7.630000114440918,
                    -10.699999809265137,
                    15.09000015258789,
                    10.25,
                    -18.15999984741211
                  ],
                ],
              },
            },
            'R': {
              'V': {
                'DT': 'F32',
                'D': [
                  0.05000000074505806,
                  9.739999771118164,
                  7.079999923706055,
                  15.489999771118164,
                  -17.989999771118164,
                ],
              },
              'I': 2,
              'L': {
                'S': {
                  'DT': 'F32',
                  'D': [
                    [
                      7.289999961853027,
                      11.15999984741211,
                      -9.510000228881836,
                      -1.8899999856948853,
                      -18.940000534057617
                    ],
                    [
                      -9.630000114440918,
                      18.81999969482422,
                      -14.399999618530273,
                      -1.909999966621399,
                      -6.579999923706055
                    ],
                  ],
                },
              },
              'R': {
                'S': {
                  'DT': 'F32',
                  'D': [
                    [
                      3.430000066757202,
                      10.90999984741211,
                      11.619999885559082,
                      -12.930000305175781,
                      -11.65999984741211
                    ],
                    [
                      19.809999465942383,
                      3.1700000762939453,
                      14.270000457763672,
                      0.05000000074505806,
                      -17.93000030517578
                    ],
                    [
                      0.05000000074505806,
                      9.739999771118164,
                      7.079999923706055,
                      15.489999771118164,
                      -17.989999771118164
                    ],
                  ],
                },
              },
            },
          },
          'R': {
            'V': {
              'DT': 'F32',
              'D': [
                2.7899999618530273,
                -9.149999618530273,
                6.559999942779541,
                -18.59000015258789,
                13.529999732971191,
              ],
            },
            'I': 0,
            'L': {
              'V': {
                'DT': 'F32',
                'D': [
                  -6.480000019073486,
                  1.100000023841858,
                  9.279999732971191,
                  0.8999999761581421,
                  6.090000152587891,
                ]
              },
              'I': 1,
              'L': {
                'V': {
                  'DT': 'F32',
                  'D': [
                    -15.970000267028809,
                    -15.949999809265137,
                    7.710000038146973,
                    9.699999809265137,
                    16.940000534057617,
                  ]
                },
                'I': 2,
                'L': {
                  'S': {
                    'DT': 'F32',
                    'D': [
                      [
                        -9.880000114440918,
                        -5.659999847412109,
                        -16.149999618530273,
                        4.460000038146973,
                        2.3399999141693115,
                      ],
                    ],
                  },
                },
                'R': {
                  'S': {
                    'DT': 'F32',
                    'D': [
                      [
                        -8.130000114440918,
                        -5.230000019073486,
                        18.010000228881836,
                        1.9700000286102295,
                        9.079999923706055
                      ],
                      [
                        -10.949999809265137,
                        -19.579999923706055,
                        9.050000190734863,
                        17.389999389648438,
                        3.299999952316284
                      ],
                      [
                        -15.970000267028809,
                        -15.949999809265137,
                        7.710000038146973,
                        9.699999809265137,
                        16.940000534057617
                      ],
                    ],
                  },
                },
              },
              'R': {
                'V': {
                  'DT': 'F32',
                  'D': [
                    -6.480000019073486,
                    1.100000023841858,
                    9.279999732971191,
                    0.8999999761581421,
                    6.090000152587891
                  ],
                },
                'I': 3,
                'L': {
                  'S': {
                    'DT': 'F32',
                    'D': [
                      [
                        -7.559999942779541,
                        11.970000267028809,
                        6.550000190734863,
                        -7.539999961853027,
                        15.899999618530273
                      ],
                      [
                        -15.010000228881836,
                        16.1200008392334,
                        -10.420000076293945,
                        -17.610000610351562,
                        6.269999980926514
                      ],
                    ],
                  },
                },
                'R': {
                  'S': {
                    'DT': 'F32',
                    'D': [
                      [
                        -17.649999618530273,
                        13.100000381469727,
                        5.820000171661377,
                        8.609999656677246,
                        14.40999984741211
                      ],
                      [
                        -6.480000019073486,
                        1.100000023841858,
                        9.279999732971191,
                        0.8999999761581421,
                        6.090000152587891
                      ],
                    ],
                  },
                },
              },
            },
            'R': {
              'V': {
                'DT': 'F32',
                'D': [
                  19.40999984741211,
                  -4.960000038146973,
                  3.990000009536743,
                  16.350000381469727,
                  10.569999694824219,
                ],
              },
              'I': 2,
              'L': {
                'S': {
                  'DT': 'F32',
                  'D': [
                    [
                      11.300000190734863,
                      8.890000343322754,
                      -17.65999984741211,
                      -5.170000076293945,
                      16.200000762939453
                    ],
                  ],
                },
              },
              'R': {
                'S': {
                  'DT': 'F32',
                  'D': [
                    [
                      19.40999984741211,
                      -4.960000038146973,
                      3.990000009536743,
                      16.350000381469727,
                      10.569999694824219
                    ],
                    [
                      13.979999542236328,
                      -8.210000038146973,
                      17.010000228881836,
                      -5.139999866485596,
                      14.489999771118164
                    ],
                    [
                      2.7899999618530273,
                      -9.149999618530273,
                      6.559999942779541,
                      -18.59000015258789,
                      13.529999732971191
                    ]
                  ],
                },
              },
            },
          },
        },
        'D': 'float32',
      });
    });
  });
}
